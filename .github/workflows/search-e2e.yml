name: Scheduled E2E Search and Telegram

on:
  schedule:
    - cron: '0 */2 * * *' # every 2 hours
  workflow_dispatch: {}

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run Cypress tests and send Telegram
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          CYPRESS_baseUrl: ${{ secrets.CYPRESS_BASE_URL }}
        run: |
          set -euo pipefail
          # run cypress and capture exit code without failing the step
          set +e
          npx cypress run --spec "cypress/e2e/monitoring.cy.js"
          STATUS=$?
          set -e

          if [ "$STATUS" -eq 0 ]; then
            MESSAGE="%F0%9F%91%8D%20%20Global%20Travel%3A%20Search%20OK%20-%20status%20200"
          else
            MESSAGE="%E2%9A%A0%EF%B8%8F%20Global%20Travel%3A%20Search%20FAILED%20-%20status%20${STATUS}"
          fi

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode=HTML \
            -d text="${MESSAGE}"
